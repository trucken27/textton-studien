<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Studie om textmeddelanden</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .hidden { display: none; }
    .question-block { margin-bottom: 30px; }
    label { display: block; margin: 6px 0 3px; }
    input[type="range"] { width: 100%; }
    button { margin-top: 20px; padding: 10px 20px; }

    .scale {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      margin-top: 2px;
      margin-bottom: 15px;
      padding: 0 2px;
    }
    .scale span {
      width: 14%;
      text-align: center;
    }
    
  </style>
</head>
<body>
  <h1>Studie om textmeddelanden</h1>

  <div id="intro">
    <p>Välkommen! Den här studien undersöker hur vi uppfattar ton i textmeddelanden. Du kommer att få se 12 meddelanden från antingen en chef eller en vän, och svara på 3 frågor för varje meddelande.</p>
    <p>Studien är anonym, frivillig, och du kan avbryta när som helst. Valfritt ID ombeds endast för att kunna särskilja deltagare med samma ålder och pronomen. Genom att klicka på "Nästa" ger du ditt informerade samtycke till att delta.</p>
    <p>Om du har några frågor kan du kontakta oss på: gusnhoknsi@student.gu.se</p>
    <p>Formuleringen i meddelandena varierar – ibland med punkt, utropstecken eller utan skiljetecken.</p>
    <p>Efter varje meddelande får du svara på tre frågor om hur du uppfattade tonen. Det är viktigt att du utgår från hur det är skrivet och vem som skickar det.</p>

    <label for="pid">Ditt deltagar-ID (t.ex. li92):</label>
    <input type="text" id="pid" required maxlength="20" />
    
    <label for="age">Din ålder:</label>
    <input type="number" id="age" required min="1" max="125" />

    <label for="gender">Ditt kön:</label>
    <select id="gender">
      <option value="">-- Välj --</option>
      <option value="Kvinna">Kvinna</option>
      <option value="Man">Man</option>
      <option value="Icke-binär/Annat">Icke-binär/Annat</option>
      <option value="Vill ej uppge">Vill ej uppge</option>
    </select>

    <br><br>
    <button onclick="startStudy()">Starta studien</button>
  </div>

  <div id="experiment" class="hidden"></div>

  <div id="end" class="hidden">
    <h2>Tack för ditt deltagande!</h2>
    <p>Dina svar har skickats in.</p>
  </div>

  <script>
    const stimuli = [];
    const kontexter = ['Chef', 'Vän'];
    const skiljetecken = ['.', '!', ''];
    const meddelanden = [
      'Det blev inte riktigt som jag hade tänkt mig',
      'Jag trodde faktiskt att det skulle bli bättre'
    ];

    let responses = [];
    let current = 0;
    let participantInfo = {};

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

function startStudy() {
  const pid = document.getElementById('pid').value.trim();
  const ageValue = document.getElementById('age').value.trim();
  const gender = document.getElementById('gender').value;

  if (!pid || pid.length > 20 || !/^[a-zA-Z0-9_-]+$/.test(pid)) {
    return alert('ID måste anges (max 20 tecken) och får endast innehålla bokstäver, siffror, bindestreck eller understreck.');
  }

  const age = parseInt(ageValue);
  if (isNaN(age) || age < 1 || age > 125) {
    return alert('Ange en giltig ålder mellan 1 och 125 (endast heltal).');
  }

  if (!gender) {
    return alert('Välj ett könsalternativ.');
  }

  participantInfo = { pid, age, gender };

  document.getElementById('intro').classList.add('hidden');
  document.getElementById('experiment').classList.remove('hidden');

  kontexter.forEach(kontext => {
    skiljetecken.forEach(tecken => {
      meddelanden.forEach(text => {
        stimuli.push({ kontext, tecken, text });
      });
    });
  });

  shuffle(stimuli);
  showNext();
}


    function showNext() {
      const container = document.getElementById('experiment');
      container.innerHTML = '';

      if (current >= stimuli.length) {
        container.classList.add('hidden');
        document.getElementById('end').classList.remove('hidden');
        return;
      }

      const stim = stimuli[current];
      const fullText = stim.text + stim.tecken;
      const contextText = stim.kontext === 'Chef'
        ? 'Föreställ dig att du får följande meddelande från din chef:'
        : 'Föreställ dig att du får följande sms från en nära vän:';

      const block = document.createElement('div');
      block.className = 'question-block';
      block.innerHTML = `
        <p><strong>${contextText}</strong></p>
        <blockquote>${fullText}</blockquote>

        <label>Hur vänlig upplevde du tonen? (1 = Inte alls, 7 = Mycket)</label>
        <input type="range" min="1" max="7" value="4" id="q1" />
        <div class="scale"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>

        <label>Hur allvarligt kändes meddelandet? (1 = Inte alls, 7 = Mycket)</label>
        <input type="range" min="1" max="7" value="4" id="q2" />
        <div class="scale"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>

        <label>Hur mjuk eller hård uppfattade du avsändaren? (1 = Mjukast, 7 = Hårdast)</label>
        <input type="range" min="1" max="7" value="4" id="q3" />
        <div class="scale"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span></div>

        <button id="nextButton" onclick="saveResponse()">Nästa</button>
        <span id="loading" style="display:none; margin-left:10px;">Skickar svar...</span>
      `;

      container.appendChild(block);
    }

    function saveResponse() {
      const nextBtn = document.getElementById('nextButton');
      const loadingSpan = document.getElementById('loading');

      nextBtn.disabled = true;
      loadingSpan.style.display = 'inline';

      const q1 = document.getElementById('q1').value;
      const q2 = document.getElementById('q2').value;
      const q3 = document.getElementById('q3').value;
      const stim = stimuli[current];

      const dataToSend = {
        participant_id: participantInfo.pid,
        age: participantInfo.age,
        gender: participantInfo.gender,
        stimulus_order: current + 1,
        context: stim.kontext,
        punctuation: stim.tecken || 'Inget',
        message: stim.text,
        friendliness: q1,
        seriousness: q2,
        harshness: q3
      };

      responses.push(dataToSend);

      sendResponseToSheetDB(dataToSend).then(() => {
        nextBtn.disabled = false;
        loadingSpan.style.display = 'none';
        current++;
        showNext();
      }).catch(() => {
        alert('Något gick fel när vi försökte skicka ditt svar. Försök igen.');
        nextBtn.disabled = false;
        loadingSpan.style.display = 'none';
      });
    }

    function sendResponseToSheetDB(data) {
      return fetch('https://sheetdb.io/api/v1/jrge0h8g0ne99', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ data: data })
      }).then(response => {
        if (!response.ok) {
          return Promise.reject('Fel vid sändning till SheetDB: ' + response.statusText);
        }
      });
    }
  </script>
</body>
</html>
